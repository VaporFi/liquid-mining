name: CI

on: [push]

env:
  FOUNDRY_PROFILE: ci

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Run Forge build
        run: |
          forge --version
          forge build --sizes
        id: build

      - name: Run Forge tests
        run: |
          forge test -vvv
        id: test

      - name: Run Forge coverage
        run: |
          forge coverage --report lcov --output-dir coverage
      - name: Check code coverage
        uses: actions/github-script@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const parse = require('lcov-parse');

            const lcov = fs.readFileSync('./coverage/lcov.info', 'utf8');
            parse(lcov, (err, data) => {
              if (err) throw err;
              const coverage = data.reduce((acc, file) => acc + file.lines.hit / file.lines.found, 0) / data.length;
              if (coverage < 0.9) throw new Error(`Code coverage is ${coverage * 100}%`);
            });
